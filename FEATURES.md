# Новые функции платформы

## 1. Отображение статуса авторизации пользователя

### Компонент UserStatus
Расположение: `src/components/auth/user-status.tsx`

**Функциональность:**
- Показывает статус авторизации пользователя
- Отображает имя пользователя или email
- Проверяет наличие доступа к стриму (оплаченный доступ)
- Показывает статус доступа с помощью цветных бейджей
- Кнопка выхода из аккаунта

**Использование:**
```tsx
import { UserStatus } from '@/components/auth/user-status'

// Полная версия с деталями
<UserStatus showDetails={true} />

// Компактная версия
<UserStatus showDetails={false} />
```

**Интеграция:**
- Главная страница: компактная версия в хедере
- Страница стрима: полная версия с деталями

## 2. Одноустройственный доступ к стриму

### Компонент StreamSessionManager
Расположение: `src/components/stream/stream-session-manager.tsx`

**Функциональность:**
- Проверяет активные сессии стрима на других устройствах
- Блокирует доступ если есть активная сессия на другом устройстве
- Позволяет закрыть сессию на другом устройстве
- Показывает информацию об активных устройствах
- Управляет разрешением на просмотр стрима

**API Endpoints:**

### `/api/stream/check-session`
- **POST**: Проверка возможности начать стрим
- **GET**: Получение списка активных сессий

**Параметры POST:**
```json
{
  "deviceFingerprint": "string" // Отпечаток устройства
}
```

**Ответ:**
```json
{
  "canStream": boolean,
  "hasActiveSession": boolean,
  "activeDevices": [
    {
      "id": "string",
      "deviceInfo": object,
      "lastActivity": "string",
      "streamId": "string"
    }
  ],
  "message": "string"
}
```

### `/api/stream/close-session`
**Обновлен для поддержки закрытия по sessionId:**

**Параметры POST:**
```json
{
  "sessionId": "string", // ID конкретной сессии
  "streamId": "string",  // ID стрима (опционально)
  "reason": "user_request" | "admin_action" | "session_timeout" | "device_limit"
}
```

### Хук useDeviceFingerprint
Расположение: `src/hooks/useDeviceFingerprint.ts`

**Функциональность:**
- Генерирует уникальный отпечаток устройства
- Использует библиотеку FingerprintJS
- Кэширует результат для повторного использования

## 3. Обновления страницы стрима

**Изменения в `/src/app/stream/page.tsx`:**

1. **Добавлен статус пользователя** в верхней части страницы
2. **Добавлен менеджер сессий** для контроля одноустройственного доступа
3. **Условное отображение видео** - видео показывается только если разрешен доступ
4. **Обновлена информация о доступе** - указано ограничение "одно устройство одновременно"
5. **Добавлена кнопка закрытия стрима** в боковую панель

## 4. Обновления главной страницы

**Изменения в `/src/app/page.tsx`:**

1. **Добавлен компонент UserStatus** в хедер (компактная версия)
2. **Адаптивная навигация** - меню скрывается на мобильных устройствах
3. **Стилизация статуса** с полупрозрачным фоном

## Принцип работы одноустройственного доступа

1. **При входе на страницу стрима:**
   - Генерируется отпечаток устройства
   - Проверяются активные сессии пользователя
   - Если есть активная сессия на другом устройстве - блокируется доступ

2. **Если обнаружена активная сессия:**
   - Показывается список активных устройств
   - Пользователь может закрыть сессию на другом устройстве
   - После закрытия автоматически обновляется статус

3. **При разрешенном доступе:**
   - Создается новая сессия в базе данных
   - Видеоплеер становится доступным
   - Отслеживается активность сессии

4. **При закрытии стрима:**
   - Сессия помечается как неактивная
   - Пользователь перенаправляется на главную страницу
   - Освобождается слот для просмотра на другом устройстве

## Безопасность

- Все API endpoints требуют авторизации
- Используется Supabase service role key для административных операций
- Отпечатки устройств генерируются на клиенте и не содержат личной информации
- Сессии автоматически истекают при неактивности

## Технические детали

**Зависимости:**
- `@fingerprintjs/fingerprintjs` - для генерации отпечатков устройств
- `zod` - для валидации API запросов
- `framer-motion` - для анимаций
- `lucide-react` - для иконок

**База данных:**
- Таблица `device_sessions` для отслеживания активных сессий
- Таблица `payments` для проверки доступа
- Таблица `user_profiles` для информации о пользователях