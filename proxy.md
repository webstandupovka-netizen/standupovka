# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ MAIB Proxy

–î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ proxy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å MAIB API —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å Fixie.

## –û–±–∑–æ—Ä

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ proxy –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å MAIB API. Proxy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

## 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
```bash
npm install https-proxy-agent@^7.0.6
```

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `package.json`:
```json
{
  "dependencies": {
    "https-proxy-agent": "^7.0.6"
  }
}
```

## 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
# Fixie Proxy URL
FIXIE_URL=http://username:password@proxy-server:port

# MAIB API credentials
MAIB_PROJECT_ID=your_project_id
MAIB_PROJECT_SECRET=your_project_secret
MAIB_SIGNATURE_KEY=your_signature_key
```

### –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Vercel
```bash
vercel env add FIXIE_URL
vercel env add MAIB_PROJECT_ID
vercel env add MAIB_PROJECT_SECRET
vercel env add MAIB_SIGNATURE_KEY
```

## 3. –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –§–∞–π–ª: `src/lib/maib-client.ts`

#### –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è proxy –∞–≥–µ–Ω—Ç–∞
```typescript
private createProxyAgent(): HttpsProxyAgent<string> | undefined {
  const fixieUrl = process.env.FIXIE_URL;
  if (fixieUrl) {
    console.log('Using Fixie proxy for MAIB requests:', {
      proxyUrl: fixieUrl.replace(/:\/\/[^:]+:[^@]+@/, '://***:***@'),
      timestamp: new Date().toISOString()
    });
    return new HttpsProxyAgent(fixieUrl);
  }
  return undefined;
}
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ HTTP –∑–∞–ø—Ä–æ—Å–∞—Ö

**–î–ª—è https.request:**
```typescript
const agent = this.createProxyAgent();
const options: https.RequestOptions = {
  hostname: url.hostname,
  port: url.port || 443,
  path: url.pathname,
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
    'Content-Length': Buffer.byteLength(postData)
  },
  agent: agent // Proxy –∞–≥–µ–Ω—Ç
};
```

**–î–ª—è fetch API:**
```typescript
const agent = this.createProxyAgent();
const fetchOptions: RequestInit = {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  },
  body: JSON.stringify(data)
};

if (agent) {
  (fetchOptions as any).agent = agent;
}
```

## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ API endpoints

### –§–∞–π–ª—ã —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π:
- `src/app/api/payments/maib/route.ts`
- `src/app/api/payments/maib/callback/route.ts`
- `src/app/api/orders/[orderId]/payment/route.ts`

–í–æ –≤—Å–µ—Ö —ç—Ç–∏—Ö —Ñ–∞–π–ª–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `maibClient`, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç proxy –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `FIXIE_URL`.

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

#### 1. –û–±—â–∏–π —Ç–µ—Å—Ç proxy —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```bash
node test-proxy.js
```
–§–∞–π–ª: `test-proxy.js` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É Fixie proxy —á–µ—Ä–µ–∑ –ø–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞.

#### 2. –¢–µ—Å—Ç MAIB API —á–µ—Ä–µ–∑ proxy
```bash
node test-maib-proxy.js
```
–§–∞–π–ª: `test-maib-proxy.js` - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞ MAIB API —Å proxy –∏ –±–µ–∑.

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
```bash
node check-production-ip.js
```
–§–∞–π–ª: `check-production-ip.js` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç IP –∞–¥—Ä–µ—Å –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç MAIB API.

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ —Ç–µ—Å—Ç–æ–≤
```bash
üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MAIB API —á–µ—Ä–µ–∑ Fixie –ø—Ä–æ–∫—Å–∏...
üì° –ü—Ä–æ–∫—Å–∏ URL: http://***:***@proxy-server:port

1Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MAIB API –±–µ–∑ –ø—Ä–æ–∫—Å–∏...
üåê –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:
   –°—Ç–∞—Ç—É—Å: 200
   –û—Ç–≤–µ—Ç: {"token": "..."}

2Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MAIB API —á–µ—Ä–µ–∑ Fixie –ø—Ä–æ–∫—Å–∏...
üîí –ß–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:
   –°—Ç–∞—Ç—É—Å: 200
   –û—Ç–≤–µ—Ç: {"token": "..."}

‚úÖ MAIB API —É—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Fixie –ø—Ä–æ–∫—Å–∏!
```

## 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ proxy —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ proxy –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```typescript
console.log('Using Fixie proxy for MAIB requests:', {
  proxyUrl: fixieUrl.replace(/:\/\/[^:]+:[^@]+@/, '://***:***@'),
  timestamp: new Date().toISOString()
});
```

### –õ–æ–≥–∏ MAIB –∑–∞–ø—Ä–æ—Å–æ–≤
```typescript
console.log('MAIB Payment Request:', {
  url: `${this.baseUrl}/pay`,
  hasToken: !!token,
  requestBody,
  timestamp: new Date().toISOString()
});
```

## 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- URL proxy –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö: `http://***:***@proxy-server:port`
- –¢–æ–∫–µ–Ω—ã –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç –∏—Ö –Ω–∞–ª–∏—á–∏—è
- –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –í—Å–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥—ã

## 8. Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Proxy –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `FIXIE_URL`
```bash
echo $FIXIE_URL
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
```bash
node test-proxy.js
node test-maib-proxy.js
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç FIXIE_URL
**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```
http://username:password@proxy-server:port
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–∞–π–º–∞—É—Ç—ã
**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö:
```typescript
req.setTimeout(15000, () => {
  req.destroy();
  reject(new Error('Timeout'));
});
```

## 9. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
- Proxy –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `FIXIE_URL`
- Fallback –Ω–∞ –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ proxy –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö API endpoints

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –†–∞–±–æ—Ç–∞–µ—Ç —Å `https.request`
- –†–∞–±–æ—Ç–∞–µ—Ç —Å `fetch` API
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã HTTP

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## 10. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env.local`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `npm run dev`

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω (Vercel)
1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏ Vercel
2. –î–µ–ø–ª–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ proxy

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ proxy —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å MAIB –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Fixie

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é —Ä–∞–±–æ—Ç—É —Å MAIB API —á–µ—Ä–µ–∑ Fixie proxy, –≤–∫–ª—é—á–∞—è:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ proxy
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Comprehensive —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ—Å—Ç—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–º–æ—â–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ç–µ—Å—Ç–æ–≤—ã–º —Ñ–∞–π–ª–∞–º –∏ –ª–æ–≥–∞–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.